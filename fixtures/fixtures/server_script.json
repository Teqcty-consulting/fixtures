[
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-05 09:53:25.132046",
  "module": null,
  "name": "Stock Check",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Material Request",
  "script": "# Trigger: DocType Event\r\n# Reference Doctype: Material Request\r\n# Event: After Submit (recommended)\r\n\r\nif doc.workflow_state == \"Approved\":\r\n    any_missing = False\r\n\r\n    for item in doc.items:\r\n        warehouse = item.warehouse or doc.set_warehouse\r\n        if not warehouse:\r\n            frappe.msgprint(f\"No warehouse set for item {item.item_code}\")\r\n            continue\r\n\r\n        # Get available stock\r\n        stock = frappe.db.get_value(\r\n            \"Bin\",\r\n            {\"item_code\": item.item_code, \"warehouse\": warehouse},\r\n            \"actual_qty\"\r\n        ) or 0\r\n\r\n        if stock >= item.qty:\r\n            # ‚úÖ Enough stock ‚Äî create draft Stock Entry\r\n            se = frappe.new_doc(\"Stock Entry\")\r\n            se.stock_entry_type = \"Material Issue\"\r\n            se.company = doc.company\r\n            se.append(\"items\", {\r\n                \"item_code\": item.item_code,\r\n                \"qty\": item.qty,\r\n                \"s_warehouse\": warehouse\r\n            })\r\n            se.insert(ignore_permissions=True)\r\n            frappe.msgprint(f\"Draft Stock Entry {se.name} created for {item.item_code}.\")\r\n        else:\r\n            # ‚ùå Not enough stock\r\n            any_missing = True\r\n            frappe.msgprint(f\"Stock not sufficient for {item.item_code}. Need to purchase.\")\r\n\r\n    # üü° If any shortage ‚Üí change MR type to Purchase\r\n    if any_missing:\r\n        try:\r\n            doc.db_set(\"material_request_type\", \"Purchase\", update_modified=True)\r\n            #frappe.msgprint(\"Material Request type changed to 'Purchase'. Refresh to see the update.\")\r\n        except Exception as e:\r\n            frappe.log_error(f\"Could not change MR type: {e}\", \"Material Request Script\")\r\n            frappe.msgprint(\"Unable to change Material Request type ‚Äî check Error Log.\")\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "Daily",
  "modified": "2025-11-05 22:00:01.913864",
  "module": null,
  "name": "Auto RFQ",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "import frappe\r\nfrom frappe.utils import nowdate\r\nfrom your_app.api import create_rfq_for_material  # Import your existing function\r\n\r\ndef create_rfq_for_material_scheduler():\r\n    \"\"\"\r\n    Scheduler function to create RFQs automatically.\r\n    Can be called manually via Scheduler Events.\r\n    \"\"\"\r\n\r\n    # Example data: you could also fetch these from a Purchase Request table\r\n    rfq_requests = [\r\n        {\"item_code\": \"SE\", \"quantity\": 10, \"supplier_name\": \"India Mart\", \"required_date\": \"2025-12-31\"},\r\n    ]\r\n\r\n    for req in rfq_requests:\r\n        try:\r\n            rfq_name = create_rfq_for_material(\r\n                item_code=req[\"item_code\"],\r\n                quantity=req[\"quantity\"],\r\n                supplier_name=req[\"supplier_name\"],\r\n                required_date=req.get(\"required_date\")\r\n            )\r\n            frappe.log_error(f\"Scheduler created RFQ {rfq_name} for {req['item_code']}\", \"RFQ Scheduler Success\")\r\n\r\n        except Exception as e:\r\n            frappe.log_error(f\"Error creating RFQ for {req['item_code']}: {frappe.get_traceback()}\", \"RFQ Scheduler Error\")\r\n",
  "script_type": "Scheduler Event"
 },
 {
  "allow_guest": 0,
  "api_method": "create_rfq_for_material",
  "cron_format": null,
  "disabled": 1,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-05 21:59:53.387974",
  "module": null,
  "name": "API",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": null,
  "script": "import frappe\r\nfrom frappe.utils import nowdate\r\n\r\n@frappe.whitelist()\r\ndef create_rfq_for_material(item_code, quantity, supplier_name, required_date=None):\r\n    \"\"\"\r\n    Creates a Request for Quotation for a given item and supplier.\r\n    \"\"\"\r\n    try:\r\n        # Debug log to confirm script is running\r\n        frappe.log_error(\"RFQ script triggered\", \"RFQ Debug\")\r\n\r\n        # Validate Item and Supplier exist\r\n        if not frappe.db.exists(\"Item\", item_code):\r\n            frappe.throw(f\"Item '{item_code}' does not exist!\")\r\n\r\n        if not frappe.db.exists(\"Supplier\", supplier_name):\r\n            frappe.throw(f\"Supplier '{supplier_name}' does not exist!\")\r\n\r\n        # Create new RFQ\r\n        rfq = frappe.new_doc(\"Request for Quotation\")\r\n        rfq.transaction_date = nowdate()\r\n        rfq.required_date = required_date or nowdate()\r\n        rfq.append(\"suppliers\", {\"supplier\": supplier_name})\r\n        rfq.append(\"items\", {\"item_code\": item_code, \"qty\": float(quantity)})\r\n\r\n        # Insert and commit to DB\r\n        rfq.insert()\r\n        frappe.db.commit()\r\n\r\n        # Log success\r\n        frappe.log_error(f\"RFQ '{rfq.name}' created successfully for item '{item_code}'\", \"RFQ Success\")\r\n\r\n        # Return RFQ name so it can be used in API response\r\n        return rfq.name\r\n\r\n    except Exception as e:\r\n        # Log errors and throw for API response\r\n        frappe.log_error(frappe.get_traceback(), \"RFQ Creation Error\")\r\n        frappe.throw(f\"Error creating RFQ: {e}\")\r\n",
  "script_type": "API"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-14 16:08:37.286699",
  "module": null,
  "name": "set stock status",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Material Request",
  "script": "stock_insufficient = False\nfor item in doc.items:\n    actual_qty = frappe.db.get_value(\"Bin\", {\n        \"item_code\": item.item_code,\n        \"warehouse\": item.warehouse\n    }, \"actual_qty\") or 0\n\n    if actual_qty < item.qty:\n        stock_insufficient = True\n        break\n\n\nif stock_insufficient:\n    doc.custom_stock_status = \"Stock Not Available\" \nelse:\n    doc.custom_stock_status = \"Stock Available\"\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-11-14 14:41:28.262544",
  "module": null,
  "name": "create pr if stock N/A",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Material Request",
  "script": "if doc.stock_status == \"Stock Not Available\":\n    pr = frappe.new_doc(\"Purchase Request\")\n    pr.material_request = doc.name\n    pr.company = doc.company\n    pr.transaction_date = frappe.utils.nowdate()\n    pr.items = []\n\n    for item in doc.items:\n        pr.append(\"items\", {\n            \"item_code\": item.item_code,\n            \"qty\": item.qty,\n            \"warehouse\": item.warehouse,\n            \"schedule_date\": item.schedule_date\n        })\n\n    pr.insert()\n    pr.submit()\n    frappe.throw(f\"Stock not available. Purchase Request {pr.name} has been created and submitted.\")",
  "script_type": "DocType Event"
 }
]